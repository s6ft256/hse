<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0, viewport-fit=cover">-->
  <title>Enhanced HSE Inspection Report System</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>👷</text></svg>">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBWTp1MM5ADIAa-2MLfxxuNfOvQ4lhvqFY",
      authDomain: "hse-web-50021.firebaseapp.com",
      projectId: "hse-web-50021",
      storageBucket: "hse-web-50021.appspot.com",
      messagingSenderId: "793301108173",
      appId: "1:793301108173:web:3c5b54ca2bc86cc6797084"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
    
    // User state
    let currentUser = null;
    
    // Modify form submission
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('hseForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const inspectionData = {
        location: document.getElementById('location').value.trim(),
        date: document.getElementById('date').value,
        risk: document.getElementById('risk').value,
        responsible: document.getElementById('responsible').value,
        inspector: document.getElementById('inspector').value,
        observation: document.getElementById('observation').value.trim(),
        actionTaken: document.getElementById('actionTaken').value.trim(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        assessor: currentUser || {}
      };
    
      // Process file uploads if any - using Base64 encoding
      const photoFiles = document.getElementById('photo').files;
      if (photoFiles.length > 0) {
        // Show uploading status
        const submitButton = document.querySelector('#hseForm button[type="submit"]');
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>Processing Images...';
        submitButton.disabled = true;
        
        try {
          // Use new helpers:
          const photoData = await processPhotos(photoFiles);
          inspectionData.photos = photoData;
          await db.collection('inspections').add(inspectionData);
          alert('Report submitted with photos successfully!');
          this.reset();
        } catch (error) {
          console.error("Error submitting report with photos: ", error);
          alert('Error submitting report: ' + error.message);
        } finally {
          // Reset button state
          submitButton.innerHTML = originalText;
          submitButton.disabled = false;
        }
      } else {
        db.collection('inspections').add(inspectionData)
          .then(() => {
            alert('Report submitted successfully!');
            this.reset();
          })
          .catch(error => {
            console.error("Error submitting report: ", error);
            alert('Error submitting report: ' + error.message);
          });
      }
    });
  });
    // Update user profile in sidebar
    function updateUserProfile(user) {
      const userProfile = document.getElementById('userProfile');
      const userAvatar = document.getElementById('userAvatar');
      const userName = document.getElementById('userName');
      
      if (user) {
        // Check if the user name contains 'elius' (case-insensitive) to use custom avatar
        if (user.name && user.name.toLowerCase().includes('elius')) {
          userAvatar.src = 'Elius.jpg';
        } else {
          userAvatar.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236c757d"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
        }
        userName.textContent = user.name || 'User';
        userProfile.style.display = 'flex';
      } else {
        userProfile.style.display = 'none';
      }
    }
    
    // Enable all tabs after successful authentication
    function enableAllTabs() {
      const tabs = document.querySelectorAll('.tab-disabled');
      tabs.forEach(tab => {
        tab.classList.remove('tab-disabled');
      });
    }
    
    // Advanced Sign out function with instant feedback
    function signOut() {
      const logoutBtn = document.querySelector('.logout-btn');
      if (logoutBtn) {
        logoutBtn.disabled = true;
        logoutBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
      }

      auth.signOut().then(() => {
        // This code runs after successful sign-out from Firebase
        console.log('User signed out successfully from Firebase');

        // Clear user data
        localStorage.removeItem('assessorData');
        currentUser = null;

        // Reset UI
        document.getElementById('authContainer').style.display = 'block';
        document.getElementById('assessorManagement').style.display = 'none';
        const assessorForm = document.getElementById('assessorForm');
        if (assessorForm) {
          assessorForm.reset();
        }
        updateUserProfile(null);

        // Disable all tabs
        const tabs = document.querySelectorAll('.nav-link:not(#assessor-tab)');
        tabs.forEach(tab => tab.classList.add('tab-disabled'));

        // Switch to Assessor tab
        const assessorTab = new bootstrap.Tab(document.getElementById('assessor-tab'));
        assessorTab.show();

        // Show confirmation and reset button
        const logoutToast = new bootstrap.Toast(document.getElementById('logoutToast'));
        logoutToast.show();
        if (logoutBtn) {
          logoutBtn.disabled = false;
          logoutBtn.innerHTML = 'Logout';
        }
      }).catch((error) => {
        console.error('Sign out error:', error);
        // Re-enable button on error
        if (logoutBtn) {
          logoutBtn.disabled = false;
          logoutBtn.innerHTML = 'Logout';
        }
        alert('Failed to log out. Please try again.');
      });
    }
    
    // Convert file to Base64
    function convertToBase64(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }
    
    // New photo processing functions
    async function processPhotos(files) {
      return await Promise.all(
        Array.from(files).map(async (file) => {
          const base64 = await fileToBase64(file);
          return {
            name: file.name,
            url: base64,  // This will work permanently
            size: (file.size / (1024 * 1024)).toFixed(2) + 'MB'
          };
        })
      );
    }

    function fileToBase64(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(file);
      });
    }
    
    // Save assessor information
    async function saveAssessorInfo() {
      try {
        const assessorName = document.getElementById('assessorName').value.trim();
        const assessorId = document.getElementById('assessorId').value.trim();

        // Validate required fields
        if (!assessorName || !assessorId) {
          alert('Assessor Name and Assessor ID are required to continue.');
          return; // Stop the function if validation fails
        }

        // Ensure we have an authenticated user
        if (!auth.currentUser) {
          throw new Error("Please wait while we authenticate you...");
        }

        const assessorData = {
          name: document.getElementById('assessorName').value.trim(),
          assessorId: document.getElementById('assessorId').value.trim(), // Save manual ID
          uid: auth.currentUser.uid, // Save Firebase UID
          department: document.getElementById('department').value,
          certification: document.getElementById('certification').value,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Save to Firestore
        await db.collection('assessors').doc(auth.currentUser.uid).set(assessorData);
        
        // Update UI
        currentUser = assessorData;
        updateUserProfile(currentUser);
        enableAllTabs();
        updateInspectorDropdown(assessorData.name); // Use latest saved name
        alert('Profile saved successfully!');
        
      } catch (error) {
        console.error("Save error:", error);
        alert(`Error: ${error.message}. Please try again.`);
      }
    }
    
    // Load and display observations from Firestore in real-time
    function loadObservations() {
      const observationsList = document.getElementById('observationsList');
      const statsContainer = document.querySelector('.stats-container');
      const chartsContainer = document.querySelector('.chart-wrapper');
      
      // Show loading state
      observationsList.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-3">Loading observations...</p></div>';
      
      // Hide stats and charts initially
      if (statsContainer) statsContainer.style.display = 'none';
      if (chartsContainer) chartsContainer.style.display = 'none';
      
      db.collection('inspections').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
        observationsList.innerHTML = '';
        const observations = [];
        
        if (snapshot.empty) {
          observationsList.innerHTML = `
            <div class="col-12 text-center py-5">
              <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
              <h4 class="mt-3">No observations found</h4>
              <p class="text-muted">Submit your first inspection report to see it here</p>
            </div>
          `;
          return;
        }
        
        // Process each document
        snapshot.forEach(doc => {
          const data = doc.data();
          const timestamp = data.timestamp ? data.timestamp.toDate() : new Date();
          const formattedDate = timestamp.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric'
          });
          
          observations.push({
            id: doc.id,
            ...data,
            formattedDate
          });
          
          const card = document.createElement('div');
          card.className = 'col-md-6 col-lg-4 mb-4';
          const docId = doc.id; // Get the Firestore document ID
          
          card.innerHTML = `
            <div class="card h-100 observation-card" style="cursor: pointer; transition: transform 0.2s ease;" 
                 onclick="expandObservation(this)" 
                 data-id="${docId}">
              <div class="card-header d-flex justify-content-between align-items-center">
                <span class="badge bg-${data.risk === 'High' ? 'danger' : data.risk === 'Medium' ? 'warning' : 'success'}">
                  ${data.risk || 'N/A'}
                </span>
                <div class="d-flex align-items-center">
                  <small class="text-muted me-2">${formattedDate}</small>
                  <button class="btn btn-sm btn-outline-danger" 
                          onclick="event.stopPropagation(); deleteObservation('${docId}')"
                          title="Delete observation">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
              <div class="card-body">
                <h5 class="card-title">${data.location || 'No Location'}</h5>
                <h6 class="card-subtitle mb-2 text-muted">Inspector: ${data.inspector || 'N/A'}</h6>
                <div class="observation-content" style="max-height: 100px; overflow: hidden; transition: max-height 0.3s ease;">
                  <p class="card-text">${data.observation || 'No observation details'}</p>
                  ${data.actionTaken ? `<p class="card-text"><strong>Action Taken:</strong> ${data.actionTaken}</p>` : ''}
                </div>
              </div>
              <div class="card-footer bg-transparent d-flex justify-content-between align-items-center">
                <small class="text-muted">Responsible: ${data.responsible || 'N/A'}</small>
                <small class="text-primary">Click to expand</small>
              </div>
            </div>
          `;
          observationsList.appendChild(card);
        });
        
        // Show stats and charts if they exist
        if (statsContainer) statsContainer.style.display = 'flex';
        if (chartsContainer) chartsContainer.style.display = 'block';
        
        // Update statistics
        updateStatistics(observations);
        
      }, error => {
        console.error('Error loading observations:', error);
        observationsList.innerHTML = `
          <div class="col-12 text-center py-5">
            <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
            <h4 class="mt-3">Error loading observations</h4>
            <p class="text-muted">${error.message || 'Please try again later'}</p>
            <button class="btn btn-primary mt-2" onclick="loadObservations()">
              <i class="bi bi-arrow-clockwise"></i> Retry
            </button>
          </div>
        `;
      });
    }

    // Update statistics based on observations
    function updateStatistics(observations) {
      if (!observations.length) return;
      
      // Update counters
      const highRisk = observations.filter(o => o.risk === 'High').length;
      const mediumRisk = observations.filter(o => o.risk === 'Medium').length;
      const lowRisk = observations.filter(o => o.risk === 'Low').length;
      
      document.getElementById('totalObservations').textContent = observations.length;
      document.getElementById('highRiskCount').textContent = highRisk;
      document.getElementById('mediumRiskCount').textContent = mediumRisk;
      document.getElementById('lowRiskCount').textContent = lowRisk;
      
      // Update charts if they exist
      if (window.renderCharts && typeof window.renderCharts === 'function') {
        window.renderCharts(observations);
      }
    }

    // Toggle observation expansion
    function expandObservation(card) {
      const content = card.querySelector('.observation-content');
      const isExpanded = card.classList.contains('expanded');
      
      if (isExpanded) {
        content.style.maxHeight = '100px';
        card.classList.remove('expanded');
      } else {
        content.style.maxHeight = content.scrollHeight + 'px';
        card.classList.add('expanded');
      }
    }

    // Delete observation from Firestore
    async function deleteObservation(docId) {
      if (!confirm('Are you sure you want to delete this observation? This action cannot be undone.')) {
        return;
      }

      try {
        await db.collection('inspections').doc(docId).delete();
        // The real-time listener will automatically update the UI
        showNotification('Observation deleted successfully', 'success');
      } catch (error) {
        console.error('Error deleting observation:', error);
        showNotification('Failed to delete observation: ' + error.message, 'danger');
      }
    }

    // Show notification to user with enhanced styling and icons
    function showNotification(message, type = 'info', title = null) {
      // Map notification types to icons
      const icons = {
        success: 'check-circle-fill',
        danger: 'exclamation-triangle-fill',
        warning: 'exclamation-triangle-fill',
        info: 'info-circle-fill'
      };
      
      // Set default title based on type if not provided
      if (!title) {
        title = type.charAt(0).toUpperCase() + type.slice(1);
      }
      
      const toast = document.createElement('div');
      toast.className = `toast notification-${type} rounded-3 shadow-sm`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      // Add animation class
      toast.style.transition = 'all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55)';
      toast.style.transform = 'translateX(120%)';
      
      // Set icon color based on type
      const iconColor = type === 'warning' ? '#000' : '#fff';
      
      toast.innerHTML = `
        <div class="toast-header bg-${type} text-white border-0 rounded-top-3">
          <i class="bi bi-${icons[type] || 'info-circle-fill'} me-2"></i>
          <strong class="me-auto">${title}</strong>
          <small class="text-white-50">just now</small>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body bg-white text-dark rounded-bottom-3">
          <div class="d-flex align-items-center">
            <div class="flex-grow-1">
              ${message}
            </div>
          </div>
        </div>
        <div class="progress" style="height: 3px;">
          <div class="progress-bar bg-${type} progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      `;
      
      const toastContainer = document.querySelector('.toast-container') || createToastContainer();
      toastContainer.appendChild(toast);
      
      // Force reflow to enable animation
      void toast.offsetWidth;
      
      // Show toast with animation
      setTimeout(() => {
        toast.style.transform = 'translateX(0)';
      }, 10);
      
      const bsToast = new bootstrap.Toast(toast, { 
        autohide: true, 
        delay: 5000,
        animation: false // We handle animation manually
      });
      
      bsToast.show();
      
      // Add progress bar animation
      const progressBar = toast.querySelector('.progress-bar');
      if (progressBar) {
        progressBar.style.transition = 'width 5s linear';
        setTimeout(() => {
          progressBar.style.width = '0%';
        }, 100);
      }
      
      // Remove the toast after it's hidden
      toast.addEventListener('hidden.bs.toast', () => {
        toast.style.transform = 'translateX(120%)';
        setTimeout(() => {
          toast.remove();
        }, 400);
      });
    }
    
    function createToastContainer() {
      const container = document.createElement('div');
      container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
      container.style.zIndex = '1100';
      container.style.maxWidth = '350px';
      container.style.width = '100%';
      document.body.appendChild(container);
      return container;
    }
    
    // Call loadObservations once during initialization
    document.addEventListener('DOMContentLoaded', function() {
      loadObservations();
    });

    // Update inspector dropdown with the current assessor's name
    function updateInspectorDropdown(assessorName) {
      const inspectorSelect = document.getElementById('inspector');
      if (inspectorSelect) {
        // Clear existing options except the first one
        while (inspectorSelect.options.length > 1) {
          inspectorSelect.remove(1);
        }
        
        // Add the assessor's name as an option and select it
        const option = new Option(assessorName, assessorName, false, true);
        inspectorSelect.add(option);
      }
    }
    
    // Check if user has an assessor profile
    async function checkAssessorProfile(uid) {
      const doc = await db.collection('assessors').doc(uid).get();
      if (doc.exists) {
        currentUser = { ...doc.data(), id: uid };
        updateUserProfile(currentUser);
        enableAllTabs();
      }
    }
    
    // Initialize the application when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      // Check for existing assessor data
      const savedAssessor = localStorage.getItem('assessorData');
      if (savedAssessor) {
        currentUser = JSON.parse(savedAssessor);
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('assessorManagement').style.display = 'block';
        updateUserProfile(currentUser);
        enableAllTabs();
        
        // Update inspector dropdown with saved assessor name
        updateInspectorDropdown(currentUser.name);
      }
      
      // Initialize date field with current date
      const dateField = document.getElementById('date');
      if (dateField) {
        dateField.value = new Date().toISOString().split('T')[0];
      }
      
      // Add event listener for save assessor button
      document.getElementById('saveAssessorBtn').addEventListener('click', async () => {
        // Show loading state
        const btn = document.getElementById('saveAssessorBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Saving...';
        
        await saveAssessorInfo();
        
        // Reset button state
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Save & Continue';
      });
      
      // Initialize other components...
    });
    
    // Add Firebase Auth state listener
    auth.onAuthStateChanged((user) => {
      if (user) {
        // User is signed in
        currentUser = user;
        checkAssessorProfile(user.uid);
      } else {
        // No user signed in
        auth.signInAnonymously().catch(console.error);
      }
    });
  </script>
  <style>
    :root {
      --bg-main: #f8f9fb;
      --bg-card: rgba(255,255,255,0.85);
      --bg-menu: rgba(255,255,255,0.45);
      --text-main: #1a1a1a;
      --text-link: #1976d2;
      --text-link-hover: #004ba0;
      --shadow-main: 0 4px 24px rgba(0,0,0,0.08);
      --primary-color: #1976d2;
      --danger-color: #dc3545;
      --success-color: #28a745;
      --warning-color: #ffc107;
    }

    /* Dark theme variables */
    [data-theme="dark"] {
      --bg-main: #121212;
      --bg-card: rgba(30, 30, 30, 0.9);
      --bg-menu: rgba(40, 40, 40, 0.8);
      --text-main: #f0f0f0;
      --text-link: #64b5f6;
      --text-link-hover: #90caf9;
      --shadow-main: 0 4px 24px rgba(0, 0, 0, 0.3);
    }

    body {
      background: linear-gradient(135deg, #e0e7ff 0%, #d1e0fd 100%);
      min-height: 100vh;
      font-family: 'Roboto', sans-serif;
      color: var(--text-main);
      -webkit-backdrop-filter: blur(16px);
      backdrop-filter: blur(16px);
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Main Layout */
    .main-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .glass-card {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 1.5rem;
      width: calc(100% - 2rem);
      max-width: 1620px;
      margin: 1rem auto;
      box-shadow: var(--shadow-main);
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      animation: fadeIn 1s ease-in-out;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow-x: hidden;
    }

    .glass-card:hover {
      transform: scale(1.01);
      box-shadow: 0 12px 36px rgba(0, 0, 0, 0.25);
    }

    /* Typography */
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
    }
    
    h2 {
      position: relative;
      padding-bottom: 10px;
      margin-bottom: 25px;
    }
    
    h2:after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      height: 3px;
      width: 60px;
      background: var(--primary-color);
      border-radius: 3px;
    }
    
    .card-title {
      font-weight: 600;
    }

    /* Side Menu */
    .side-menu {
      position: relative;
      left: 0;
      top: 0;
      height: 100%;
      min-width: 220px;
      max-width: 250px;
      background: var(--bg-menu);
      box-shadow: 2px 0 16px rgba(71, 20, 20, 0.08);
      z-index: 1040;
      padding: 1rem 0.5rem;
      border-radius: 20px 0 0 20px;
      transition: all 0.3s ease;
      overflow-y: auto;
    }

    .menu-heading {
      color: var(--primary-color);
      font-weight: 700;
      font-size: 1.25rem;
      letter-spacing: 2px;
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .nav-link {
      color: var(--text-main) !important;
      transition: all 0.3s ease;
      margin-bottom: 8px;
      border-radius: 8px;
      text-align: left;
      font-family: 'Montserrat', sans-serif;
      font-weight: 500;
      padding: 0.75rem 1rem;
    }

    .nav-link.active, .nav-link:focus {
      background: var(--primary-color);
      color: white !important;
      box-shadow: 0 4px 12px rgba(6, 50, 94, 0.3);
    }

    .nav-link:hover {
      background: rgba(6, 50, 94, 0.1);
      transform: scale(1.05);
    }

    /* Content Area */
    .tab-content {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      min-height: 0;
      width: 100%;
    }

    /* Form Elements */
    .form-control, .form-select {
      border-radius: 12px;
      transition: all 0.3s ease;
      padding: 0.75rem 1rem;
      font-family: 'Roboto', sans-serif;
      border: 1px solid rgba(0,0,0,0.1);
    }

    .form-control:focus, .form-select:focus {
      box-shadow: 0 0 0 0.25rem rgba(6, 50, 94, 0.25);
      border-color: #86b7fe;
    }

    textarea.form-control {
      resize: vertical;
      min-height: 120px;
      max-height: 300px;
    }

    label {
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-family: 'Montserrat', sans-serif;
    }

    /* Buttons */
    .btn {
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 500;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-primary:hover {
      background-color: #1565c0;
      border-color: #1565c0;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(6, 50, 94, 0.3);
    }
    
    .btn-outline-primary {
      border-width: 2px;
    }

    /* Observation Cards */
    .observation-card {
      opacity: 0;
      transform: translateY(30px);
      animation: observationFadeIn 0.7s cubic-bezier(0.23, 1, 0.32, 1) forwards;
      margin-bottom: 1.5rem;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      border: none;
    }

    .observation-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    
    .badge {
      font-weight: 500;
      padding: 0.5em 0.8em;
      border-radius: 8px;
      font-family: 'Montserrat', sans-serif;
    }

    /* Google Sheets Embed */
    .sheet-container {
      position: relative;
      width: 100%;
      height: 0;
      padding-bottom: 75%;
      overflow: hidden;
      border-radius: 12px;
      background: rgba(255,255,255,0.1);
      margin: 1rem 0;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.05);
    }

    .sheet-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Equipment Tabs */
    .equipment-tabs-container {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.05);
      margin-top: 1rem;
    }
    
    .nav-tabs {
      border-bottom: 2px solid rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
    }
    
    .nav-tabs .nav-link {
      border: none;
      border-radius: 12px 12px 0 0;
      margin-bottom: -2px;
      padding: 0.8rem 1.5rem;
      font-weight: 500;
      color: var(--text-main);
    }
    
    .nav-tabs .nav-link.active {
      background: var(--primary-color);
      color: white !important;
      border-bottom: 2px solid var(--primary-color);
    }
    
    .nav-tabs .nav-link:hover:not(.active) {
      background: rgba(6, 50, 94, 0.1);
    }
    
    .tab-pane h3 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      color: var(--primary-color);
    }

    /* About Me Section */
    .profile-img {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border: 3px solid var(--primary-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #1976d2;
      margin: 0 auto 1.5rem;
    }
    
    .social-links {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 1.5rem;
    }
    
    .social-links .btn {
      margin: 0;
      min-width: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .list-group-item {
      background: transparent;
      border: none;
      padding: 0.75rem 1.25rem;
      font-family: 'Roboto', sans-serif;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes observationFadeIn {
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes tabPop {
      0% { transform: scale(0.8); }
      60% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Responsive Adjustments */
    @media (max-width: 992px) {
      .side-menu {
        min-width: 200px;
      }
      
      .glass-card {
        padding: 1.25rem;
      }
    }

    @media (max-width: 768px) {
      .d-flex.flex-row {
        flex-direction: column;
      }
      
      .side-menu {
        max-width: 100%;
        height: auto;
        max-height: 200px;
        border-radius: 20px 20px 0 0;
        margin-bottom: 1rem;
      }
      
      .tab-content {
        padding: 1rem;
      }
      
      .social-links {
        flex-direction: column;
        align-items: center;
      }
    }

    @media (max-width: 576px) {
      .glass-card {
        padding: 1rem;
        margin: 0.75rem auto;
        width: calc(100% - 1.5rem);
      }
      
      .profile-img {
        width: 120px;
        height: 120px;
      }
      
      .social-links .btn {
        width: 100%;
      }
      
      .nav-tabs .nav-link {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
    }
    
    /* Theme Toggle Button */
    .theme-toggle {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary-color);
      color: white;
      border: none;
      box-shadow: var(--shadow-main);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    .theme-toggle i {
      transition: transform 0.3s ease;
    }

    [data-theme="dark"] .glass-card,
    [data-theme="dark"] .glass-link {
      background: var(--bg-card);
      color: var(--text-main);
    }

    [data-theme="dark"] .card,
    [data-theme="dark"] .form-control,
    [data-theme="dark"] .form-select {
      background-color: var(--bg-card);
      color: var(--text-main);
      border-color: #444;
    }

    [data-theme="dark"] .form-control:focus,
    [data-theme="dark"] .form-select:focus {
      background-color: var(--bg-card);
      color: var(--text-main);
      border-color: var(--primary-color);
    }
    
    [data-theme="dark"] body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }
    
    [data-theme="dark"] h2:after {
      background: var(--text-link);
    }
    
    /* Plant & Equipment custom styling */
    .plant-equipment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .equipment-description {
      background: rgba(6, 50, 94, 0.08);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    
    .equipment-stats {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .stat-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    
    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 0.5rem 0;
      font-family: 'Montserrat', sans-serif;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-main);
      opacity: 0.8;
    }
    
    .equipment-section {
      margin-bottom: 2rem;
    }
    
    .equipment-section h3 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    
    [data-theme="dark"] .equipment-section h3 {
      border-bottom: 1px solid rgba(6, 50, 94, 0.1);
    }
    
    .equipment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .equipment-item {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }
    
    .equipment-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .equipment-icon {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
    }
    
    .equipment-info {
      margin-top: 0.5rem;
    }
    
    /* Notification Styles */
    .toast-container {
      z-index: 1100;
      position: fixed;
      bottom: 20px;
      right: 20px;
      max-width: 350px;
      width: 100%;
    }
    
    .toast {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      margin-bottom: 15px;
      border: none;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      transform: translateX(120%);
      opacity: 1;
      border-left: 4px solid transparent;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.hide {
      transform: translateX(120%);
    }
    
    .toast-header {
      border: none;
      padding: 12px 15px;
      font-weight: 600;
      background-color: rgba(255,255,255,0.1);
    }
    
    .toast-body {
      padding: 15px;
      font-size: 0.95rem;
    }
    
    /* Notification Types */
    .toast.bg-success {
      background-color: #198754 !important;
      border-left-color: #0f5132;
    }
    
    .toast.bg-danger {
      background-color: #dc3545 !important;
      border-left-color: #842029;
    }
    
    .toast.bg-warning {
      background-color: #ffc107 !important;
      color: #000;
      border-left-color: #997404;
    }
    
    .toast.bg-info {
      background-color: #0dcaf0 !important;
      border-left-color: #087990;
    }
    
    /* Progress bar animation */
    .progress {
      height: 3px;
      background: rgba(0,0,0,0.1);
      border-radius: 0;
    }
    
    .progress-bar {
      transition: width 5s linear;
    }
    
    /* Authentication Styles */
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      text-align: center;
    }
    
    .auth-card {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--shadow-main);
      backdrop-filter: blur(10px);
      max-width: 400px;
      width: 100%;
    }
    
    .embedded-content {
      width: 100%;
      height: 600px;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      margin: 20px 0;
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0.5rem 1rem;
      background: var(--bg-card);
      border-radius: 25px;
      margin-bottom: 1rem;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      margin-left: auto;
    }
    
    .tab-disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
      border-bottom: 1px dashed rgba(0,0,0,0.1);
    }
    
    [data-theme="dark"] .info-item {
      border-bottom: 1px dashed rgba(6, 50, 94, 0.1);
    }
    
    .info-label {
      font-weight: 500;
    }
    
    .info-value {
      font-weight: 500;
      color: var(--primary-color);
    }
    
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: 0.5rem;
      display: inline-block;
    }
    
    .status-active {
      background: rgba(40, 167, 69, 0.15);
      color: #28a745;
    }
    
    .status-inactive {
      background: rgba(220, 53, 69, 0.15);
      color: #dc3545;
    }
    
    .status-maintenance {
      background: rgba(255, 193, 7, 0.15);
      color: #ffc107;
    }
    
    /* Profile icon styling */
    .profile-icon {
      font-size: 4rem;
      color: white;
    }
    
    /* Image preview styles */
    .img-preview-container {
      position: relative;
      width: 100px;
      height: 100px;
      margin: 0 10px 10px 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.2s ease-in-out;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      display: inline-block;
    }
    
    .img-preview-container:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    
    .img-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    .file-preview {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 10px;
      background: #f8f9fa;
    }
    
    /* Image modal styles */
    #imageModal .modal-content {
      background-color: #f8f9fa;
      border: none;
      box-shadow: 0 5px 30px rgba(0,0,0,0.2);
    }
    
    #imageModal .modal-header {
      border-bottom: 1px solid #e9ecef;
      background-color: #fff;
    }
    
    #imageModal .modal-footer {
      border-top: 1px solid #e9ecef;
      background-color: #fff;
    }
    
    #modalImage {
      max-height: 70vh;
      max-width: 100%;
      margin: 0 auto;
      display: block;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    /* Dark theme adjustments for image previews */
    [data-theme="dark"] .img-preview-container {
      background-color: #2d2d2d;
      border-color: #444;
    }
    
    [data-theme="dark"] .file-preview {
      background-color: #2d2d2d;
      color: #f0f0f0;
    }
    
    [data-theme="dark"] #imageModal .modal-content {
      background-color: #1e1e1e;
      color: #f0f0f0;
    }
    
    [data-theme="dark"] #imageModal .modal-header,
    [data-theme="dark"] #imageModal .modal-footer {
      background-color: #252525;
      border-color: #444;
    }
    
    /* Stats counters */
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-item {
      flex: 1;
      min-width: 200px;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    
    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin: 5px 0;
    }
    
    .stat-title {
      font-size: 0.9rem;
      color: var(--text-main);
      opacity: 0.8;
    }
    
    /* Login form */
    .login-container {
      max-width: 500px;
      margin: 0 auto;
      padding: 30px;
      background: var(--bg-card);
      border-radius: 15px;
      box-shadow: var(--shadow-main);
    }
    
    .chart-container {
      height: 300px;
      margin: 30px 0;
    }
    
    .chart-wrapper {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body data-theme="light">
  <div class="main-container">
    <div class="glass-card">
      <div class="d-flex flex-row flex-grow-1" style="min-height: 0; position: relative; overflow-y: auto;">
        <!-- Side Menu -->
        <div class="side-menu nav flex-column nav-pills" id="hseTabs" role="tablist" aria-orientation="vertical">
          <div class="menu-heading">MENU</div>
          <!-- User Profile Display (when logged in) -->
          <div id="userProfile" class="user-profile" style="display: none;">
            <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
            <span id="userName"></span>
            <button class="logout-btn" onclick="signOut()">Logout</button>
          </div>
          
          <button class="nav-link active" id="assessor-tab" data-bs-toggle="pill" data-bs-target="#assessor" type="button" role="tab">
            <i class="bi bi-person-badge me-2"></i>Assessor/Inspector
          </button>
          <button class="nav-link tab-disabled" id="inspection-tab" data-bs-toggle="pill" data-bs-target="#inspection" type="button" role="tab">
            <i class="bi bi-clipboard-check me-2"></i>Inspection Report
          </button>
          <button class="nav-link tab-disabled" id="observations-tab" data-bs-toggle="pill" data-bs-target="#observations" type="button" role="tab">
            <i class="bi bi-eye me-2"></i>Observations
          </button>
          <button class="nav-link tab-disabled" id="p2411-tab" data-bs-toggle="pill" data-bs-target="#p2411" type="button" role="tab">
            <i class="bi bi-folder me-2"></i>P2411_Folder
          </button>
          <button class="nav-link tab-disabled" id="plant-equipment-tab" data-bs-toggle="pill" data-bs-target="#plant_equipment" type="button" role="tab">
            <i class="bi bi-tools me-2"></i>Plant & Equipment
          </button>
          <button class="nav-link tab-disabled" id="trainings-tab" data-bs-toggle="pill" data-bs-target="#trainings" type="button" role="tab">
            <i class="bi bi-journal-text me-2"></i>Trainings
          </button>
          <button class="nav-link tab-disabled" id="aboutme-tab" data-bs-toggle="pill" data-bs-target="#aboutme" type="button" role="tab">
            <i class="bi bi-person-circle me-2"></i>ABOUT ME
          </button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content flex-grow-1" id="hseTabContent">
          <!-- Assessor/Inspector Tab (Now First and Active) -->
          <div class="tab-pane fade show active" id="assessor" role="tabpanel">
            <h2><i class="bi bi-person-badge me-2"></i>Assessor/Inspector Authentication</h2>
            
            <!-- Authentication Container -->
            <div id="authContainer" class="text-center py-5">
              <div class="card p-4 mx-auto" style="max-width: 500px;">
                <div class="card-body">
                  <h4 class="mb-4">Enter your assessor details to continue</h4>
                  <button class="btn btn-primary" onclick="document.getElementById('assessorManagement').style.display = 'block'; document.getElementById('authContainer').style.display = 'none';">
                    <i class="bi bi-person-plus me-2"></i>Enter Assessor Information
                  </button>
                  <div class="mt-3 text-center">
                    <small class="text-muted">By continuing, you agree to our terms of service and privacy policy.</small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Assessor Management (Shown after authentication) -->
            <div id="assessorManagement" style="display: none;">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="assessorName" class="form-label">Assessor Name</label>
                  <input type="text" class="form-control" id="assessorName" placeholder="Enter your name" required>
                </div>
                <div class="col-md-6">
                  <label for="assessorId" class="form-label">Assessor ID</label>
                  <input type="text" class="form-control" id="assessorId" placeholder="Enter your ID" required>
                </div>
                <div class="col-md-6">
                  <label for="department" class="form-label">Department</label>
                  <select class="form-select" id="department" required>
                    <option disabled selected value="">Select Department</option>
                    <option value="HSE">HSE</option>
                    <option value="Engineering">Engineering</option>
                    <option value="Operations">Operations</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Quality">Quality</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="certification" class="form-label">Certification Level</label>
                  <select class="form-select" id="certification" required>
                    <option disabled selected value="">Select Level</option>
                    <option value="Level 1">Level 1 - Basic</option>
                    <option value="Level 2">Level 2 - OFFICER</option>
                    <option value="Level 3">Level 3 - ENGNEER</option>
                    <option value="Level 4">Level 4 - MANAGER</option>
                  </select>
                </div>
                <div class="col-12">
                  <button id="saveAssessorBtn" class="btn btn-success w-100">
                    <i class="bi bi-check-circle me-2"></i>Save & Continue
                  </button> 
                </div>
              </div>
            </div>
          </div>
          
          <!-- Inspection Report Tab -->
          <div class="tab-pane fade" id="inspection" role="tabpanel">
            <h2><i class="bi bi-clipboard-check me-2"></i>HSE Inspection Report</h2>
            <form id="hseForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="location" class="form-label">Location</label>
                  <input type="text" class="form-control" id="location" placeholder="Enter inspection location" required>
                </div>
                <div class="col-md-6">
                  <label for="date" class="form-label">Date</label>
                  <input type="date" class="form-control" id="date" required>
                </div>
                <div class="col-md-6">
                  <label for="risk" class="form-label">Risk Level</label>
                  <select class="form-select" id="risk" required>
                    <option disabled selected value="">Select risk level</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="responsible" class="form-label">Responsible Engineer</label>
                  <select class="form-select" id="responsible" required onchange="handleResponsibleChange()">
                    <option disabled selected value="">Select Engineer</option>
                    <option value="Rameez">Rameez</option>
                    <option value="Rashad">Rashad</option>
                    <option value="Elaya">Elaya</option>
                    <option value="Martin">Martin</option>
                    <option value="write_custom">Add Engneer Name</option>
                  </select>
                  <input type="text" class="form-control mt-2" id="customResponsible" placeholder="Enter engineer name" style="display: none;">
                </div>
                <div class="col-md-6">
                  <label for="inspector" class="form-label">Inspector Name</label>
                  <select class="form-select" id="inspector" required>
                    <option disabled selected value="">Select Inspector</option>
                  </select>
                </div>
                <div class="col-12">
                  <label for="observation" class="form-label">Observation</label>
                  <textarea class="form-control" id="observation" placeholder="Describe your observation in detail..." required></textarea>
                </div>
                <div class="col-12">
                  <label for="actionTaken" class="form-label">Action Taken</label>
                  <textarea class="form-control" id="actionTaken" placeholder="Describe the corrective action taken or planned..." rows="3"></textarea>
                </div>
                <div class="col-12">
                  <label for="photo" class="form-label">Upload Photo</label>
                  <input type="file" class="form-control" id="photo" accept="image/*" multiple>
                  <div class="form-text">Maximum 5 photos (5MB each)</div>
                </div>
                <div class="col-12 mt-4">
                  <button type="submit" class="btn btn-primary w-100 py-2">
                    <i class="bi bi-send-check me-2"></i>Submit Report
                  </button>
                </div>
              </div>
            </form>
          </div>



          <!-- Observations Tab -->
          <div class="tab-pane fade" id="observations" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h2><i class="bi bi-eye me-2"></i>Observation Records</h2>
              <button class="btn btn-outline-primary" id="exportObservations">
                <i class="bi bi-download me-2"></i>Export
              </button>
            </div>
            
            <div class="stats-container">
              <div class="stat-item">
                <div class="stat-number" id="totalObservations">0</div>
                <div class="stat-title">Total Observations</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="highRiskCount">0</div>
                <div class="stat-title">High Risk</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="mediumRiskCount">0</div>
                <div class="stat-title">Medium Risk</div>
              </div>
              <div class="stat-item">
                <div class="stat-number" id="lowRiskCount">0</div>
                <div class="stat-title">Low Risk</div>
              </div>
            </div>
            
            <div class="chart-wrapper">
              <h4><i class="bi bi-bar-chart me-2"></i>Risk Distribution</h4>
              <div class="chart-container">
                <canvas id="riskChart"></canvas>
              </div>
            </div>
            
            <div class="chart-wrapper">
              <h4><i class="bi bi-people me-2"></i>Inspector Activity</h4>
              <div class="chart-container">
                <canvas id="inspectorChart"></canvas>
              </div>
            </div>
            
            <div class="sheet-container mt-4">
              <iframe src="https://docs.google.com/spreadsheets/d/1YOUR_SHEET_ID/edit?usp=sharing" 
                      allowfullscreen 
                      title="Observation Records"
                      style="border: 1px solid #dee2e6; border-radius: 8px; height: 600px;">
              </iframe>
            </div>
            <div id="observationsList" class="row g-3 mt-4"></div>
          </div>

          <!-- P2411 Folder Tab -->
          <div class="tab-pane fade" id="p2411" role="tabpanel">
            <h2><i class="bi bi-folder me-2"></i>P2411 Folders</h2>
            <div class="row g-3">
              <div class="col-md-6">
                <div class="card h-100 glass-link">
                  <div class="card-body text-center">
                    <i class="bi bi-file-earmark-slides text-primary" style="font-size: 2.5rem;"></i>
                    <h5 class="card-title mt-3">My Slides</h5>
                    <a href="https://drive.google.com/drive/folders/1-vAprXj8w3IRDTFlJCxpw7ToXw6JBJ46?usp=sharing" 
                      class="stretched-link" target="_blank"></a>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card h-100 glass-link">
                  <div class="card-body text-center">
                    <i class="bi bi-crane text-primary" style="font-size: 2.5rem;"></i>
                    <h5 class="card-title mt-3">Lifting Documents</h5>
                    <a href="https://drive.google.com/drive/folders/16Q6tteBqG-PpqHms8JO37r0swvu1X8vX?usp=sharing" 
                      class="stretched-link" target="_blank"></a>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card h-100 glass-link">
                  <div class="card-body text-center">
                    <i class="bi bi-shield-check text-primary" style="font-size: 2.5rem;"></i>
                    <h5 class="card-title mt-3">Safety Concerns</h5>
                    <a href="https://drive.google.com/drive/folders/1COg6s8vb-e6ZXM__Zgd55qHZtP1m5fAV?usp=sharing" 
                      class="stretched-link" target="_blank"></a>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card h-100 glass-link">
                  <div class="card-body text-center">
                    <i class="bi bi-gear text-primary" style="font-size: 2.5rem;"></i>
                    <h5 class="card-title mt-3">Plant Equipment</h5>
                    <a href="https://drive.google.com/drive/folders/1Kc_Gv7B9qYdODP-iHMZWETbtXSNPByDe?usp=sharing" 
                      class="stretched-link" target="_blank"></a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Plant & Equipment Tab -->
          <div class="tab-pane fade" id="plant_equipment" role="tabpanel">
            <div class="plant-equipment-header">
              <h2><i class="bi bi-tools me-2"></i>Plant & Equipment Management</h2>
              <a href="https://docs.google.com/spreadsheets/d/1lsrJyzX-57JSUTn258ELYLT15-N8t5OS/edit?usp=sharing" 
                class="btn btn-outline-primary" target="_blank">
                <i class="bi bi-box-arrow-up-right me-1"></i>Open in Sheets
              </a>
            </div>
            
            <div class="equipment-description">
              <p class="mb-0">This section provides comprehensive management of plant and equipment used in HSE operations. Track maintenance schedules, inspection records, and equipment status in real-time.</p>
            </div>
            
            <div class="equipment-stats">
              <div class="stat-card">
                <div class="stat-value">59</div>
                <div class="stat-label">Total Equipment</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">18</div>
                <div class="stat-label">Active Equipment</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">0</div>
                <div class="stat-label">Under Maintenance</div>
              </div>
              <div class="stat-card">
                <div class="stat-value">02</div>
                <div class="stat-label">Requires Inspection</div>
              </div>
            </div>
            
            <div class="equipment-tabs-container">
              <ul class="nav nav-tabs mb-4" id="equipmentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="plant-equipment-tab" data-bs-toggle="tab" data-bs-target="#plant-equipment" type="button" role="tab">
                    <i class="bi bi-tools me-1"></i>Plant Equipment
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="power-machines-tab" data-bs-toggle="tab" data-bs-target="#power-machines" type="button" role="tab">
                    <i class="bi bi-gear-fill me-1"></i>Power Machines
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="fire-extinguishers-tab" data-bs-toggle="tab" data-bs-target="#fire-extinguishers" type="button" role="tab">
                    <i class="bi bi-fire me-1"></i>Fire Safety
                  </button>
                </li>
              </ul>
              
              <div class="tab-content" id="equipmentTabsContent">
                <div class="tab-pane fade show active" id="plant-equipment" role="tabpanel">
                  <h3>Plant Equipment Overview</h3>
                  <div class="equipment-grid">
                    <div class="equipment-item">
                      <div class="equipment-image mb-3">
                        <img src="crane.jpg" alt="Mobile Crane" class="img-fluid rounded" style="max-height: 150px; width: 100%; object-fit: cover;">
                      </div>
                      <h4>MOBILE CRANE</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">EQ-0012</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">17/1/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">16/1/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-image mb-3">
                        <img src="skid.jpg" alt="Skid Steer Loader" class="img-fluid rounded" style="max-height: 150px; width: 100%; object-fit: cover;">
                      </div>
                      <h4>SKID STEER LOADER</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">EQ-0034</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">11/4/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">10/4/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="wheel.jpg" alt="Wheel Loader" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>WHEEL LOADER</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">EQ-0078</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">29/5/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">28/5/2026</span>
                        </div>
                        <span class="status-badge status-maintenance">Maintenance- Required</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="sheet-container">
                    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRxgJP6jRVZLno0cG-6AcOwveisbYHeKTXWZY2tmQ6q2GZVomVFFtIQvVxbZVoKhw/pubhtml?gid=1199586761&single=true"
                            allowfullscreen title="Plant Equipment Log"></iframe>
                  </div>
                </div>
                
                <div class="tab-pane fade" id="power-machines" role="tabpanel">
                  <h3>Power Machines</h3>
                  <div class="equipment-grid">
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="kv.jpg" alt="Generator 500KVA" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>GENERATOR 500KVA</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">PM-0021</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">01/11/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">05/6/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="comp.jpg" alt="Air Compressor" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>Air Compressor</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">PM-0045</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">28/6/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">28/02/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="water.webp" alt="Water Pump" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>Water Pump</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">PM-0056</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Last Inspection:</span>
                          <span class="info-value">15/3/2025</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Next Due:</span>
                          <span class="info-value">15/12/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="sheet-container">
                    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRxgJP6jRVZLno0cG-6AcOwveisbYHeKTXWZY2tmQ6q2GZVomVFFtIQvVxbZVoKhw/pubhtml?gid=348565325&single=true"
                            allowfullscreen title="Power Machines Log"></iframe>
                  </div>
                </div>
                
                <div class="tab-pane fade" id="fire-extinguishers" role="tabpanel">
                  <h3>Fire Safety Equipment</h3>
                  <div class="equipment-grid">
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="co2.jpg" alt="CO2 Extinguisher" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>CO2 Extinguisher</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">FE-0011</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Location:</span>
                          <span class="info-value">Rest Area</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Expiry:</span>
                          <span class="info-value">01/01/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="foam.png" alt="Foam Extinguisher" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>Foam Extinguisher</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">FE-0033</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Location:</span>
                          <span class="info-value">Diesel tank</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Expiry:</span>
                          <span class="info-value">03/02/2026</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                    
                    <div class="equipment-item">
                      <div class="equipment-icon">
                        <img src="powder.webp" alt="Dry Powder Extinguisher" class="img-fluid rounded" style="max-height: 80px; object-fit: cover;">
                      </div>
                      <h4>Dry Powder Extinguisher</h4>
                      <div class="equipment-info">
                        <div class="info-item">
                          <span class="info-label">ID:</span>
                          <span class="info-value">FE-0055</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Location:</span>
                          <span class="info-value">Storage Area</span>
                        </div>
                        <div class="info-item">
                          <span class="info-label">Expiry:</span>
                          <span class="info-value">10/12/2025</span>
                        </div>
                        <span class="status-badge status-active">Active</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="sheet-container">
                    <iframe src="https://docs.google.com/spreadsheets/d/e/2PACX-1vRxgJP6jRVZLno0cG-6AcOwveisbYHeKTXWZY2tmQ6q2GZVomVFFtIQvVxbZVoKhw/pubhtml?gid=71846233&single=true"
                            allowfullscreen title="Fire Extinguishers Log"></iframe>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Trainings Tab -->
          <div class="tab-pane fade" id="trainings" role="tabpanel">
            <h2><i class="bi bi-journal-text me-2"></i>Trainings</h2>
            <p>Details about training sessions, certifications, and schedules will be displayed here.</p>
          </div>

          <!-- About Me Tab -->
          <div class="tab-pane fade" id="aboutme" role="tabpanel">
            <div class="text-center mb-5">
              <div class="profile-img">
                <img src="Elius.jpg" alt="Profile Photo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
              </div>
              <h2>ELIUS D.A</h2>
              <h5 class="text-muted">Pentester</h5>
              <div class="social-links">
                <a href="https://wa.me/971552623327" class="btn btn-outline-success" target="_blank">
                  <i class="bi bi-whatsapp me-2"></i>WhatsApp
                </a>
                <a href="mailto:niwamanyaelius95@gmail.com" class="btn btn-outline-primary" target="_blank">
                  <i class="bi bi-envelope me-2"></i>Email
                </a>
                <a href="https://www.linkedin.com/in/elius-niwamanya-026228187/" class="btn btn-outline-primary" target="_blank">
                  <i class="bi bi-linkedin me-2"></i>LinkedIn
                </a>
              </div>
            </div>
            
            <div class="row g-4">
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-body">
                    <h4 class="card-title mb-3"><i class="bi bi-person-lines-fill me-2"></i>Professional Profile</h4>
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Lifting Supervisor
                      </li>
                      <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Penetration & Testing
                      </li>
                      <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Full-Stack Developer
                      </li>
                      <li class="list-group-item d-flex align-items-center">
                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                        Cybersecurity Enthusiast
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-body">
                    <h4 class="card-title mb-3"><i class="bi bi-info-circle-fill me-2"></i>Contact Information</h4>
                    <ul class="list-group list-group-flush">
                      <li class="list-group-item">
                        <i class="bi bi-telephone-fill me-2 text-primary"></i>
                        +971 55 262 3327
                      </li>
                      <li class="list-group-item">
                        <i class="bi bi-envelope-fill me-2 text-primary"></i>
                        niwamanyaelius95@gmail.com
                      </li>
                      <li class="list-group-item">
                        <i class="bi bi-geo-alt-fill me-2 text-primary"></i>
                        Dubai, UAE
                      </li>
                      
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark/light mode">
    <i class="bi bi-moon-fill"></i>
  </button>

  <!-- Image Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="modalImage" src="" alt="Preview" class="img-fluid" style="max-height: 70vh;">
        </div>
        <div class="modal-footer">
          <a id="downloadImage" href="#" class="btn btn-primary" download>
            <i class="bi bi-download"></i> Download
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Initialize image modal
    document.addEventListener('DOMContentLoaded', function() {
      const imageModal = document.getElementById('imageModal');
      if (imageModal) {
        imageModal.addEventListener('show.bs.modal', function(event) {
          const button = event.relatedTarget;
          const imageUrl = button.getAttribute('data-img');
          const modalImage = document.getElementById('modalImage');
          const downloadLink = document.getElementById('downloadImage');
          
          if (modalImage && downloadLink) {
            modalImage.src = imageUrl;
            downloadLink.href = imageUrl;
            downloadLink.download = imageUrl.split('/').pop() || 'inspection_image.jpg';
          }
        });
      }
    });
  </script>
  <script>
    // Theme Toggle Functionality
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = themeToggle.querySelector('i');
    const html = document.documentElement;

    // Check for saved theme preference or use preferred color scheme
    const savedTheme = localStorage.getItem('theme') || 
                      (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    
    // Apply saved theme
    html.setAttribute('data-theme', savedTheme);
    updateThemeIcon(savedTheme);

    // Toggle theme on button click
    themeToggle.addEventListener('click', () => {
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    });

    // Update theme icon based on current theme
    function updateThemeIcon(theme) {
      if (theme === 'dark') {
        themeIcon.className = 'bi bi-sun-fill';
        themeIcon.setAttribute('title', 'Switch to light mode');
      } else {
        themeIcon.className = 'bi bi-moon-fill';
        themeIcon.setAttribute('title', 'Switch to dark mode');
      }
    }

    // Listen for system theme changes
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      if (!localStorage.getItem('theme')) { // Only if user hasn't set a preference
        const newTheme = e.matches ? 'dark' : 'light';
        html.setAttribute('data-theme', newTheme);
        updateThemeIcon(newTheme);
      }
    });

    // Handle Responsible Engineer dropdown change (Global scope)
    function handleResponsibleChange() {
      const responsibleSelect = document.getElementById('responsible');
      const customInput = document.getElementById('customResponsible');
      
      if (responsibleSelect.value === 'write_custom') {
        customInput.style.display = 'block';
        customInput.required = true;
        customInput.focus();
      } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
      }
    }
    
    // Add custom responsible engineer name (Global scope)
    function addCustomResponsibleName(name) {
      if (!name || name.trim() === '') return;
      
      const responsibleSelect = document.getElementById('responsible');
      const customInput = document.getElementById('customResponsible');
      
      // Get existing custom names from localStorage
      let customNames = JSON.parse(localStorage.getItem('customResponsibleNames')) || [];
      
      // Add new name if it doesn't exist
      if (!customNames.includes(name.trim())) {
        customNames.push(name.trim());
        localStorage.setItem('customResponsibleNames', JSON.stringify(customNames));
        
        // Add option to dropdown (before 'Write name' option)
        const writeOption = responsibleSelect.querySelector('option[value="write_custom"]');
        const newOption = document.createElement('option');
        newOption.value = name.trim();
        newOption.textContent = name.trim();
        responsibleSelect.insertBefore(newOption, writeOption);
      }
      
      // Select the new name
      responsibleSelect.value = name.trim();
      customInput.style.display = 'none';
      customInput.required = false;
      customInput.value = '';
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Initialize date field with current date
      document.getElementById('date').value = new Date().toISOString().split('T')[0];
      
      // DOM elements
      const inspectorSelect = document.getElementById('inspector');
      const observationsList = document.getElementById('observationsList');
      const exportBtn = document.getElementById('exportObservations');
      const authContainer = document.getElementById('authContainer');
      const assessorManagement = document.getElementById('assessorManagement');
      
      // Data storage
      let assessorData = {};
      console.log('Loading observations from localStorage...');
      let observations = JSON.parse(localStorage.getItem('hseObservations')) || [];
      console.log('Loaded observations:', observations);
      
      // Chart instances
      let riskChart = null;
      let inspectorChart = null;
      
      // Load saved observations
      console.log('Calling renderObservations...');
      renderObservations();
      
      // Load saved assessor data if exists
      const savedAssessorData = localStorage.getItem('assessorData');
      if (savedAssessorData) {
        assessorData = JSON.parse(savedAssessorData);
        // Hide auth container and show assessor management
        if (authContainer) authContainer.style.display = 'none';
        if (assessorManagement) assessorManagement.style.display = 'block';
        
        // Update inspector dropdown
        if (inspectorSelect && assessorData.name) {
          inspectorSelect.innerHTML = `
            <option disabled selected value="">Select Inspector</option>
            <option selected value="${assessorData.name}">${assessorData.name}</option>
          `;
        }
      }
      
      // Note: Login form removed - using direct assessor management
      
      // Google Sheets Integration
      async function saveToGoogleSheets(Inspections) {
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzhE2bW3HLWlHLlranpUBY_4W5SweLUKIgSlruuZggaKBhPspgiez5bhQ1woZHeVA/exec';
        
        try {
          // Prepare data for Google Sheets
          const rowData = [
            new Date(Inspections.timestamp).toLocaleString(),
            Inspections.date,
            Inspections.inspector,
            Inspections.location,
            Inspections.risk,
            Inspections.responsible,
            Inspections.observation,
            Inspections.actionTaken || '',
            Inspections.photos.length,
            Inspections.assessor?.name || 'Unknown',
            Inspections.id
          ];
          
          // Send data to Google Sheets via Apps Script
          const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ rowData: rowData })
          });
          
          if (response.ok) {
            console.log('✅ Inspection data successfully saved to Google Sheets!');
            // Show success notification to user
            showNotification('Data saved to Google Sheets successfully!', 'success');
          } else {
            throw new Error('Failed to save to Google Sheets');
          }
          
        } catch (error) {
          console.log('❌ Error saving to Google Sheets:', error);
          showNotification('Local save successful, but Google Sheets sync failed', 'warning');
        }
      }
      
      // Show notification to user
      function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        notification.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000);
      }
      
      // Load custom responsible engineer names on page load
      function loadCustomResponsibleNames() {
        const responsibleSelect = document.getElementById('responsible');
        const customNames = JSON.parse(localStorage.getItem('customResponsibleNames')) || [];
        
        // Add custom names to dropdown
        const writeOption = responsibleSelect.querySelector('option[value="write_custom"]');
        customNames.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          responsibleSelect.insertBefore(option, writeOption);
        });
      }
      
      // Setup custom input event listeners
      const customInput = document.getElementById('customResponsible');
      if (customInput) {
        customInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            addCustomResponsibleName(this.value);
          }
        });
        
        customInput.addEventListener('blur', function() {
          if (this.value.trim()) {
            addCustomResponsibleName(this.value);
          }
        });
      }
      
      // Load existing custom names
      loadCustomResponsibleNames();
      
      // Note: Assessor form uses saveAssessorInfo() function called by button onclick
      
      // HSE Form Submission
      document.getElementById('hseForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Form validation
        const requiredFields = ['location', 'date', 'risk', 'responsible', 'inspector', 'observation'];
        for (const field of requiredFields) {
          if (!document.getElementById(field).value.trim()) {
            alert(`Please fill in the ${field} field`);
            return;
          }
        }
        
        const photoFiles = Array.from(document.getElementById('photo').files);
        if (photoFiles.length > 5) {
          alert('Maximum 5 photos allowed');
          return;
        }
        
        // Create observation object with form fields
        const obs = {
          id: Date.now(),
          location: document.getElementById('location').value.trim(),
          date: document.getElementById('date').value,
          risk: document.getElementById('risk').value,
          responsible: document.getElementById('responsible').value,
          inspector: document.getElementById('inspector').value,
          observation: document.getElementById('observation').value.trim(),
          actionTaken: document.getElementById('actionTaken').value.trim(),
          photos: photoFiles.map(f => ({ 
            name: f.name, 
            url: URL.createObjectURL(f),
            size: (f.size / (1024 * 1024)).toFixed(2) + 'MB'
          })),
          timestamp: new Date().toISOString(),
          assessor: assessorData || {}
        };
        
        console.log('Creating observation:', obs);
        
        // Add to observations array
        observations.unshift(obs);
        console.log('Observations array after adding:', observations);
        
        // Save to localStorage
        localStorage.setItem('hseObservations', JSON.stringify(observations));
        console.log('Saved to localStorage:', localStorage.getItem('hseObservations'));
        
        // Save to Google Sheets
        saveToGoogleSheets(obs);
        
        // Render updated list
        renderObservations();
        
        // Reset form
        this.reset();
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        
        alert('Inspection report submitted successfully!');
      });
      
      // Export Observations
      exportBtn.addEventListener('click', function() {
        if (observations.length === 0) {
          alert('No observations to export');
          return;
        }
        
        // Convert to CSV
        const headers = ['ID', 'Date', 'Location', 'Risk', 'Inspector', 'Responsible', 'Observation', 'Action Taken'];
        const csvRows = [
          headers.join(','),
          ...observations.map(obs => 
            [
              obs.id,
              obs.date,
              `"${obs.location.replace(/"/g, '""')}"`,
              obs.risk,
              `"${obs.inspector}"`,
              `"${obs.responsible}"`,
              `"${obs.observation.replace(/"/g, '""')}"`,
              `"${(obs.actionTaken || '').replace(/"/g, '""')}"`
            ].join(',')
          )
        ];
        
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `hse_observations_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
      
      // Render observations function
      function renderObservations() {
        if (observations.length === 0) {
          observationsList.innerHTML = `
            <div class="col-12 text-center py-5">
              <i class="bi bi-info-circle" style="font-size: 3rem; color: #6c757d;"></i>
              <h4 class="mt-3">No observations found</h4>
              <p class="text-muted">Submit your first inspection report to see it here</p>
            </div>
          `;
          
          // Update counters
          updateCounters();
          renderCharts();
          return;
        }
        
        observationsList.innerHTML = observations.map(obs => `
          <div class="col-md-6 col-lg-4">
            <div class="card observation-card h-100">
              <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                  ${obs.assessor && obs.assessor.photoURL ? `
                    <img src="${obs.assessor.photoURL}" alt="Assessor" 
                        class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;">
                  ` : '<div class="rounded-circle bg-secondary me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;"><i class="bi bi-person text-white"></i></div>'}
                  <div>
                    <h5 class="card-title mb-0">${obs.inspector}</h5>
                    <small class="text-muted">${obs.assessor && obs.assessor.position ? obs.assessor.position : 'Inspector'}</small>
                  </div>
                </div>
                
                <div class="mb-3">
                  <span class="badge bg-${getRiskColor(obs.risk)} me-2">${obs.risk} Risk</span>
                  <span class="badge bg-secondary">${formatDate(obs.date)}</span>
                </div>
                
                <div class="row g-2 mb-3">
                  <div class="col-md-6">
                    <p class="card-text mb-1"><strong><i class="bi bi-geo-alt me-2"></i>Location:</strong></p>
                    <p class="text-muted ms-3">${obs.location}</p>
                  </div>
                  <div class="col-md-6">
                    <p class="card-text mb-1"><strong><i class="bi bi-person-vcard me-2"></i>Responsible Engineer:</strong></p>
                    <p class="text-muted ms-3">${obs.responsible}</p>
                  </div>
                  <div class="col-12">
                    <p class="card-text mb-1"><strong><i class="bi bi-chat-square-text me-2"></i>Observation:</strong></p>
                    <p class="text-muted ms-3">${obs.observation}</p>
                  </div>
                </div>
                
                ${obs.photos && obs.photos.length > 0 ? `
                  <div class="mt-3">
                    <p class="small text-muted mb-2">Attachments (${obs.photos.length})</p>
                    <div class="d-flex flex-wrap">
                      ${obs.photos.map(photo => {
                        const isImage = /.(jpg|jpeg|png|gif|webp)$/i.test(photo.name);
                        const fileName = photo.name.length > 15 ? photo.name.substring(0, 12) + '...' : photo.name;
                        
                        return `
                        <div class="img-preview-container" title="${photo.name}">
                          <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#imageModal" data-img="${photo.url}">
                            ${isImage ? 
                              `<img src="${photo.url}" alt="Preview" class="img-preview">` : 
                              `<div class="file-preview">
                                <i class="bi bi-file-earmark-text text-primary" style="font-size: 2rem;"></i>
                                <small class="text-truncate mt-1">${fileName}</small>
                              </div>`
                            }
                          </a>
                          <small class="position-absolute bottom-0 start-0 end-0 text-center bg-dark bg-opacity-75 text-white py-1">
                            ${photo.size}
                          </small>
                        </div>
                      `;}).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
              <div class="card-footer bg-transparent border-top d-flex justify-content-between align-items-center">
                <small class="text-muted">Reported at ${formatTime(obs.timestamp)}</small>
                <button class="btn btn-outline-danger btn-sm" onclick="deleteObservation(${obs.id})" title="Delete observation">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `).join('');
        
        // Force reflow for animation
        document.querySelectorAll('.observation-card').forEach((card, index) => {
          setTimeout(() => {
            card.style.animationDelay = `${index * 0.1}s`;
          }, 10);
        });
        
        // Update counters and charts
        updateCounters();
        renderCharts();
      }
      
      // Update statistics counters
      function updateCounters() {
        document.getElementById('totalObservations').textContent = observations.length;
        
        const highRiskCount = observations.filter(obs => obs.risk === 'High').length;
        const mediumRiskCount = observations.filter(obs => obs.risk === 'Medium').length;
        const lowRiskCount = observations.filter(obs => obs.risk === 'Low').length;
        
        document.getElementById('highRiskCount').textContent = highRiskCount;
        document.getElementById('mediumRiskCount').textContent = mediumRiskCount;
        document.getElementById('lowRiskCount').textContent = lowRiskCount;
      }
      
      // Render charts
      function renderCharts() {
        // Destroy existing charts if they exist
        if (riskChart) riskChart.destroy();
        if (inspectorChart) inspectorChart.destroy();
        
        // Prepare data for risk chart
        const riskCounts = {
          High: 0,
          Medium: 0,
          Low: 0
        };
        
        observations.forEach(obs => {
          riskCounts[obs.risk]++;
        });
        
        // Prepare data for inspector chart
        const inspectorCounts = {};
        observations.forEach(obs => {
          const inspector = obs.inspector || 'Unknown';
          inspectorCounts[inspector] = (inspectorCounts[inspector] || 0) + 1;
        });
        
        const inspectors = Object.keys(inspectorCounts);
        const inspectorValues = Object.values(inspectorCounts);
        
        // Get colors based on theme
        const bgColor = html.getAttribute('data-theme') === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
        const borderColor = html.getAttribute('data-theme') === 'dark' ? '#64b5f6' : '#1976d2';
        const textColor = html.getAttribute('data-theme') === 'dark' ? '#f0f0f0' : '#1a1a1a';
        
        // Create risk chart
        const riskCtx = document.getElementById('riskChart').getContext('2d');
        riskChart = new Chart(riskCtx, {
          type: 'doughnut',
          data: {
            labels: ['High Risk', 'Medium Risk', 'Low Risk'],
            datasets: [{
              data: [riskCounts.High, riskCounts.Medium, riskCounts.Low],
              backgroundColor: [
                'rgba(220, 53, 69, 0.7)',
                'rgba(255, 193, 7, 0.7)',
                'rgba(40, 167, 69, 0.7)'
              ],
              borderColor: [
                'rgba(220, 53, 69, 1)',
                'rgba(255, 193, 7, 1)',
                'rgba(40, 167, 69, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: textColor
                }
              }
            }
          }
        });
        
        // Create inspector chart
        const inspectorCtx = document.getElementById('inspectorChart').getContext('2d');
        inspectorChart = new Chart(inspectorCtx, {
          type: 'bar',
          data: {
            labels: inspectors,
            datasets: [{
              label: 'Reports Submitted',
              data: inspectorValues,
              backgroundColor: 'rgba(25, 118, 210, 0.7)',
              borderColor: 'rgba(25, 118, 210, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  color: textColor
                },
                grid: {
                  color: bgColor
                }
              },
              x: {
                ticks: {
                  color: textColor
                },
                grid: {
                  color: bgColor
                }
              }
            },
            plugins: {
              legend: {
                labels: {
                  color: textColor
                }
              }
            }
          }
        });
      }
      
      // Helper functions
      function getRiskColor(risk) {
        switch (risk.toLowerCase()) {
          case 'high': return 'danger';
          case 'medium': return 'warning';
          default: return 'success';
        }
      }
      
      function formatDate(dateString) {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
      }
      
      function formatTime(dateString) {
        const options = { hour: '2-digit', minute: '2-digit' };
        return new Date(dateString).toLocaleTimeString(undefined, options);
      }
      
      // Load saved assessor if exists
      const savedAssessor = localStorage.getItem('hseAssessor');
      if (savedAssessor) {
        assessorData = JSON.parse(savedAssessor);
        inspectorSelect.innerHTML = `
          <option disabled selected value="">Select Inspector</option>
          <option selected value="${assessorData.name}">${assessorData.name}</option>
        `;
      }
    });
  </script>
  <!-- Toast Container for Logout Notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
    <div id="logoutToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          You have been signed out successfully.
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>
</body>
</html>
